<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crystal Faire — Party Tracker</title>
  <style>
    :root{
      --bg:#0f0c0a;
      --ink:#f4efe7;
      --muted:#cbbca7;
      --line:rgba(255,255,255,.14);
      --accent: rgba(42,166,164,.9);
      --danger: rgba(192,57,43,.35);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
                  linear-gradient(180deg, #241a12, var(--bg));
      padding: 16px;
    }
    .wrap{max-width:1020px;margin:0 auto;}
    h1{margin:0 0 10px;font-size:20px;letter-spacing:.2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 14px;}
    select{
      flex: 1 1 280px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--ink);
      font-weight: 950;
    }
    .btn{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight: 950;
      cursor:pointer;
    }
    .btn:hover{background: rgba(255,255,255,.12)}
    .btn.danger{border-color: rgba(192,57,43,.55); background: rgba(192,57,43,.18)}
    .btn.danger:hover{background: rgba(192,57,43,.26)}
    .card{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
    }
    .name{font-size:22px;font-weight:1000;margin:0 0 4px}
    .sub{color:var(--muted);font-weight:850;margin:0 0 12px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:820px){ .grid{grid-template-columns:1fr;} }

    .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--muted);
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.10);}
    .kv:last-child{border-bottom:none;}
    .k{color:rgba(244,239,231,.9); font-weight:900;}
    .v{color:rgba(244,239,231,.95); font-weight:1000;}

    ul{margin:0; padding-left:18px}
    li{margin:6px 0}

    .muted{color:var(--muted); font-weight:800}

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width:820px){ .inputs{grid-template-columns:1fr;} }

    input[type="number"], textarea{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      padding: 10px 12px;
      font-size: 15px;
      outline:none;
    }
    textarea{min-height:110px; resize: vertical;}
    .label{font-weight:950; margin: 0 0 6px; color: rgba(244,239,231,.92)}
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 1000;
      color: rgba(244,239,231,.95);
    }

    .slotsWrap{margin-top:8px}
    .slotsLine{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin: 8px 0;}
    .slotsLabel{min-width:92px; font-weight:950; color: rgba(244,239,231,.92)}
    .slots{display:flex; gap:8px; flex-wrap:wrap;}
    .slot{
      width: 18px; height: 18px;
      border-radius: 6px;
      border: 2px solid var(--accent);
      background: rgba(255,255,255,.12);
      transform: rotate(45deg);
      position: relative;
    }
    .slot input{position:absolute; inset:0; opacity:0;}
    .slot.on{background: var(--accent);}

    .resources{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .checkrow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 10px 10px;
    }
    .checkrow input[type="checkbox"]{transform: scale(1.2); margin-top: 2px;}
    .checkrow .title{font-weight:1000}
    .checkrow .desc{color: rgba(255,255,255,.78); font-weight:750; margin-top:2px; line-height:1.25}
    .infoBtn{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      color:#fff;
      width:28px; height:28px;
      border-radius: 10px;
      font-weight: 1000;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .infoBtn:hover{background: rgba(255,255,255,.12)}
    .foot{
      margin-top:12px;
      color:rgba(255,255,255,.75);
      font-size:12px;
      line-height:1.35
    }

    .spellList{
      display:grid;
      gap:8px;
      margin-top:8px;
    }
    .spellItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 10px 10px;
    }
    .spellItem input{transform: scale(1.2); margin-top:2px}
    .spellItem .title{font-weight:1000}
    .spellItem .meta{color: rgba(255,255,255,.78); font-weight:800; margin-top:2px}
    .spellItem .desc{color: rgba(255,255,255,.78); font-weight:750; margin-top:4px; line-height:1.25}
    .spellTopline{display:flex; justify-content:space-between; gap:10px; align-items:center;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Crystal Faire — Party Tracker</h1>

  <div class="row">
    <select id="pcSelect" aria-label="Select a character"></select>
    <button class="btn" id="shortRest">Short Rest</button>
    <button class="btn" id="longRest">Long Rest</button>
    <button class="btn danger" id="resetThis">Reset This PC (this device)</button>
  </div>

  <div class="card" id="card" hidden>
    <p class="name" id="name"></p>
    <p class="sub" id="sub"></p>

    <div class="grid">

      <!-- MOVED UP: Session Tracker + Resources -->
      <div class="box">
        <h3>Session Tracker</h3>

        <div class="inputs">
          <div>
            <div class="label">Current HP</div>
            <input type="number" id="hpCur" min="0" step="1" />
          </div>

          <div>
            <div class="label">Inventory</div>
            <textarea id="inv" placeholder="Loot, gear, items..."></textarea>
          </div>

          <div>
            <div class="label">Notes</div>
            <textarea id="notes" placeholder="Clues, NPCs, plans..."></textarea>
          </div>

          <div>
            <div class="label">Conditions / Reminders</div>
            <textarea id="conds" placeholder="Exhaustion level, Rage uses, Inspiration, etc."></textarea>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Resources (tap to mark used)</div>
          <div class="resources" id="resources"></div>
        </div>

        <div class="foot">Auto-saves on this device.</div>
      </div>

      <!-- NEW: Spells & Cantrips -->
      <div class="box" id="spellsKnownBox" hidden>
        <div class="spellTopline">
          <h3 style="margin:0">Spells & Cantrips</h3>
          <span class="pill" id="spellChoosePill">—</span>
        </div>
        <div class="muted" id="spellMeta"></div>

        <div style="margin-top:10px">
          <div class="label">Cantrips</div>
          <ul id="cantrips"></ul>
        </div>

        <div style="margin-top:10px">
          <div class="label">Spells</div>
          <div class="spellList" id="spellsPick"></div>
          <div class="foot" id="spellFoot"></div>
        </div>
      </div>

      <div class="box">
        <h3>Core</h3>
        <div class="kv"><div class="k">Level</div><div class="v" id="level"></div></div>
        <div class="kv"><div class="k">Race</div><div class="v" id="race"></div></div>
        <div class="kv"><div class="k">Class</div><div class="v" id="cls"></div></div>
        <div class="kv"><div class="k">AC</div><div class="v" id="ac"></div></div>
        <div class="kv"><div class="k">Speed</div><div class="v" id="speed"></div></div>
        <div class="kv"><div class="k">Init</div><div class="v" id="init"></div></div>
        <div class="kv"><div class="k">Prof</div><div class="v" id="prof"></div></div>
        <div class="kv"><div class="k">Max HP</div><div class="v" id="maxhp"></div></div>
        <div style="margin-top:10px">
          <span class="pill" id="hpPill">HP: —</span>
        </div>
      </div>

      <div class="box">
        <h3>Abilities</h3>
        <div class="kv"><div class="k">STR</div><div class="v" id="str"></div></div>
        <div class="kv"><div class="k">DEX</div><div class="v" id="dex"></div></div>
        <div class="kv"><div class="k">CON</div><div class="v" id="con"></div></div>
        <div class="kv"><div class="k">INT</div><div class="v" id="int"></div></div>
        <div class="kv"><div class="k">WIS</div><div class="v" id="wis"></div></div>
        <div class="kv"><div class="k">CHA</div><div class="v" id="cha"></div></div>
      </div>

      <div class="box">
        <h3>Skills</h3>
        <ul id="skills"></ul>
      </div>

      <div class="box">
        <h3>Saves</h3>
        <ul id="saves"></ul>
      </div>

      <div class="box">
        <h3>Attacks</h3>
        <ul id="attacks"></ul>
      </div>

      <div class="box">
        <h3>Class Feats</h3>
        <ul id="feats"></ul>
      </div>

      <div class="box" id="spellBox" hidden>
        <h3>Spell Slots</h3>
        <div class="muted" id="spellHint"></div>
        <div class="slotsWrap">
          <div class="slotsLine" id="lineL1" hidden>
            <div class="slotsLabel">Level 1</div>
            <div class="slots" id="slotsL1"></div>
          </div>
          <div class="slotsLine" id="lineL2" hidden>
            <div class="slotsLabel">Level 2</div>
            <div class="slots" id="slotsL2"></div>
          </div>
        </div>
        <div class="foot">Tap diamonds to mark used slots. (Spell slots reset on Long Rest.)</div>
      </div>

    </div>
  </div>
</div>

<script>
  // ========= PARTY DATA =========
  // Note: spell slots here match your tracker rules.
  // Paladin "spells prepared" rule: CHA mod + half paladin level (rounded down). :contentReference[oaicite:3]{index=3}
  const PCS = [
    {
      id:"seris", name:"Seris Dawnblade", race:"Human", cls:"Fighter", level:2,
      core:{ ac:16, speed:"30 ft", init:"+1", prof:"+2", maxHp:20 },
      abilities:{ str:"+3", con:"+2", dex:"+1", wis:"+1", int:"+0", cha:"+1" },
      skills:["Athletics +5","Perception +3","Intimidation +3"],
      saves:["Strength +5","Constitution +4"],
      attacks:["Longsword (melee) — To Hit: d20+5 — Damage: 1d8+5"],
      feats:["Second Wind — regain 1d10+2 HP (1/short rest)","Fight Style: Dueling — while using one-handed melee weapon and no other weapons, deal +2 damage","Action Surge — take one extra action (1/short rest)"],
      spellSlots:null,
      spellPick:null,
      resources:[
        { key:"second_wind", name:"Second Wind", rest:"short", effect:"Regain 1d10+2 HP. (1/Short Rest)" },
        { key:"action_surge", name:"Action Surge", rest:"short", effect:"Take one extra action on your turn. (1/Short Rest)" },
      ]
    },
    {
      id:"sable", name:"Sable Thornscar", race:"Tiefling", cls:"Fighter", level:2,
      core:{ ac:16, speed:"30 ft", init:"+2", prof:"+2", maxHp:21 },
      abilities:{ str:"+3", con:"+2", dex:"+2", wis:"+0", int:"+0", cha:"+1" },
      skills:["Intimidation +3","Athletics +5","Perception +2"],
      saves:["Strength +5","Constitution +4"],
      attacks:[
        "Greatsword (melee) — To Hit: d20+5 — Damage: 2d6+3",
        "Handaxe (20/60) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Second Wind — regain 1d10+2 HP (1/short rest)",
        "Fight Style: Great Weapon Fighting — reroll 1s/2s on damage dice",
        "Action Surge — take one extra action (1/short rest)"
      ],
      spellSlots:null,
      spellPick:null,
      resources:[
        { key:"second_wind", name:"Second Wind", rest:"short", effect:"Regain 1d10+2 HP. (1/Short Rest)" },
        { key:"action_surge", name:"Action Surge", rest:"short", effect:"Take one extra action on your turn. (1/Short Rest)" },
      ]
    },
    {
      id:"korrin", name:"Korrin Ashfang", race:"Half-Orc", cls:"Rogue", level:2,
      core:{ ac:14, speed:"30 ft", init:"+3", prof:"+2", maxHp:18 },
      abilities:{ str:"+2", con:"+2", dex:"+3", wis:"+1", int:"+0", cha:"+0" },
      skills:["Stealth +5","Perception +3","Acrobatics +5"],
      saves:["Dexterity +5","Intelligence +2"],
      attacks:[
        "Shortsword (melee) — To Hit: d20+5 — Damage: 1d6+3",
        "Shortbow (80/320) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Sneak Attack (1/turn) — advantage OR ally adjacent: +1d6 damage",
        "Cunning Action — Dash/Disengage/Hide as bonus action"
      ],
      spellSlots:null,
      spellPick:null,
      resources:[]
    },

    // Cleric table exists in SRD; L2 has 1st-level slots (standard is 3). :contentReference[oaicite:4]{index=4}
    {
      id:"haldor", name:"Haldor Brightshield", race:"Dwarf", cls:"Cleric (Life Domain)", level:2,
      core:{ ac:18, speed:"25 ft", init:"+0", prof:"+2", maxHp:18 },
      abilities:{ str:"+2", con:"+3", dex:"+0", wis:"+3", int:"+0", cha:"+1" },
      skills:["Medicine +5","Perception +5","Insight +5"],
      saves:["Wisdom +5","Charisma +3"],
      attacks:[
        "Warhammer (melee) — To Hit: d20+4 — Damage: 1d8+2",
        "Light Xbow (80/320) — To Hit: d20+2 — Damage: 1d8"
      ],
      feats:[
        "Disciple of Life — healing spells restore + (2 + spell level) extra HP",
        "Channel Divinity (1/short rest): Turn Undead OR Preserve Life (split 10 HP within 30 ft)",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      spellPick:{
        mode:"prepare",
        choose:4,
        cantrips:["(Add Haldor’s cantrips here)"],
        spells:[
          { key:"bless", name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Choose up to 3 allies. They add +1d4 to attack rolls and saving throws." },
          { key:"cure_wounds", name:"Cure Wounds", meta:"Action • 5 ft", desc:"Heal 1d8 + WIS HP." },
          { key:"prot_evil_good", name:"Protection from Evil and Good", meta:"Action • 5 ft • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations: attackers have disadvantage; target can’t be charmed/frightened/possessed by them." },
          { key:"guiding_bolt", name:"Guiding Bolt", meta:"Action • 120 ft", desc:"Ranged radiant attack: 4d6 radiant, and the next attack against that target has advantage." },
          { key:"healing_word", name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + WIS HP at range." },
          { key:"sanctuary", name:"Sanctuary", meta:"Bonus Action • 30 ft • 1 min", desc:"Protect an ally: enemies must pass a WIS save to attack them, or choose a new target." },
        ]
      },
      resources:[
        { key:"channel_divinity", name:"Channel Divinity", rest:"short", effect:"Choose Turn Undead or Preserve Life. (1/Short Rest)" },
      ]
    },

    {
      id:"ashara", name:"Ashara Solkindle", race:"Fire Genasi", cls:"Cleric (Life Domain)", level:2,
      core:{ ac:16, speed:"30 ft", init:"+0", prof:"+2", maxHp:18 },
      abilities:{ str:"+1", con:"+2", dex:"+1", wis:"+3", int:"+0", cha:"+1" },
      skills:["Medicine +5","Perception +5","Insight +5"],
      saves:["Wisdom +5","Charisma +3"],
      attacks:["Staff (melee) — To Hit: d20+3 — Damage: 1d8+1"],
      feats:[
        "Disciple of Life — healing spells restore + (2 + spell level) extra HP",
        "Channel Divinity (1/short rest): Turn Undead OR Preserve Life (split 10 HP within 30 ft)",
        "Warm Hands (1/short rest) — touch a creature to end shivering/fear",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      spellPick:{
        mode:"prepare",
        choose:4,
        cantrips:["Sacred Flame","Guidance","Spare the Dying"],
        spells:[
          { key:"bless", name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Choose up to 3 allies. They add +1d4 to attack rolls and saving throws." },
          { key:"cure_wounds", name:"Cure Wounds", meta:"Action • 5 ft", desc:"Heal 1d8 + WIS HP." },
          { key:"prot_evil_good", name:"Protection from Evil and Good", meta:"Action • 5 ft • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations: attackers have disadvantage; target can’t be charmed/frightened/possessed by them." },
          { key:"guiding_bolt", name:"Guiding Bolt", meta:"Action • 120 ft", desc:"Ranged radiant attack: 4d6 radiant, and the next attack against that target has advantage." },
          { key:"healing_word", name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + WIS HP at range." },
          { key:"sanctuary", name:"Sanctuary", meta:"Bonus Action • 30 ft • 1 min", desc:"Protect an ally: enemies must pass a WIS save to attack them, or choose a new target." },
        ]
      },
      resources:[
        { key:"channel_divinity", name:"Channel Divinity", rest:"short", effect:"Choose Turn Undead or Preserve Life. (1/Short Rest)" },
        { key:"warm_hands", name:"Warm Hands", rest:"short", effect:"Touch a creature to end shivering/fear. (1/Short Rest)" },
      ]
    },

    {
      id:"edrin", name:"Edrin Valebright", race:"Human", cls:"Paladin", level:2,
      core:{ ac:19, speed:"30 ft", init:"+0", prof:"+2", maxHp:20 },
      // FIXED SYNTAX ERROR HERE:
      abilities:{ str:"+3", con:"+2", dex:"+0", wis:"+1", int:"+0", cha:"+2" },
      skills:["Athletics +5","Persuasion +4","Insight +3"],
      saves:["Wisdom +3","Charisma +4"],
      attacks:["Longsword (melee) — To Hit: d20+5 — Damage: 1d8+3"],
      feats:[
        "Lay on Hands — heal from a pool of 10 HP / long rest",
        "Divine Smite — spend a spell slot on a hit for +2d8 radiant (+1d8 vs undead/fiends)",
        "Defense (Fighting Style) — AC +1 (already added)",
        "Spellcasting"
      ],
      spellSlots:{ l1:2, l2:0 },
      spellPick:{
        mode:"prepare",
        choose:3, // matches your sheet; also matches CHA(+2)+half L2(1)=3 :contentReference[oaicite:5]{index=5}
        cantrips:[],
        spells:[
          { key:"bless", name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Choose up to 3 allies. They add +1d4 to attack rolls and saving throws." },
          { key:"command", name:"Command", meta:"Action • 60 ft • 1 round • WIS save", desc:"Speak a 1-word command (drop, flee, halt, etc.). On a failed save, the target obeys on its next turn." },
          { key:"cure_wounds", name:"Cure Wounds", meta:"Action • 5 ft", desc:"Heal 1d8 + CHA HP." },
          { key:"prot_evil_good", name:"Protection from Evil and Good", meta:"Action • 5 ft • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations: attackers have disadvantage; target can’t be charmed/frightened/possessed by them." },
          { key:"shield_of_faith", name:"Shield of Faith", meta:"Bonus Action • Self • Concentration (1 min)", desc:"Give a creature +2 AC." },
        ]
      },
      resources:[
        { key:"lay_on_hands", name:"Lay on Hands (10 HP pool)", rest:"long", effect:"You have a 10 HP pool per long rest. Spend any amount as an action to heal." },
      ]
    },

    {
      id:"rurik", name:"Rurik Goldnote", race:"Dwarf", cls:"Bard", level:2,
      core:{ ac:14, speed:"25 ft", init:"+1", prof:"+2", maxHp:17 },
      abilities:{ str:"+1", con:"+2", dex:"+1", wis:"+0", int:"+1", cha:"+3" },
      skills:["Persuasion +5","Performance +5","History +3"],
      saves:["Dexterity +3","Charisma +5"],
      attacks:[
        "Rapier (melee) — To Hit: d20+3 — Damage: 1d8+1",
        "Dagger (20/60) — To Hit: d20+3 — Damage: 1d4+1"
      ],
      feats:[
        "Bardic Inspiration — bonus action, 3/day: give an ally a d6 to add to an attack/save/check",
        "Jack of All Trades — add +1 to any ability check you aren’t proficient in",
        "Song of Rest (d6) — during a short rest, allies heal +1d6 extra",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      spellPick:{
        mode:"known",
        choose:2, // your sheet says choose 2
        cantrips:["(Pick 2 bard cantrips)"],
        spells:[
          { key:"healing_word", name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + CHA HP at range." },
          { key:"dissonant_whispers", name:"Dissonant Whispers", meta:"Action • 60 ft • WIS save", desc:"Deal 3d6 psychic. Target must use its reaction to run away." },
          { key:"faerie_fire", name:"Faerie Fire", meta:"Action • 60 ft • Concentration (1 min) • DEX save", desc:"Outline creatures in light. Attacks against them have advantage, and they can’t turn invisible." },
          { key:"sleep", name:"Sleep", meta:"Action • 90 ft", desc:"Put creatures to sleep in an area. Works best on weak enemies." },
          { key:"tashas", name:"Tasha’s Hideous Laughter", meta:"Action • 30 ft • Concentration (1 min) • WIS save", desc:"Target falls prone laughing and is incapacitated until it saves." },
          { key:"detect_magic", name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." },
        ]
      },
      resources:[
        { key:"bardic_inspiration_1", name:"Bardic Inspiration (use #1)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_2", name:"Bardic Inspiration (use #2)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_3", name:"Bardic Inspiration (use #3)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
      ]
    },

    {
      id:"lark", name:"Lark Thistledown", race:"Halfling", cls:"Bard", level:2,
      core:{ ac:14, speed:"25 ft", init:"+3", prof:"+2", maxHp:15 },
      abilities:{ str:"-1", con:"+1", dex:"+3", wis:"+1", int:"+0", cha:"+3" },
      skills:["Deception +5","Stealth +5","Perception +3"],
      saves:["Dexterity +5","Charisma +5"],
      attacks:[
        "Rapier (melee) — To Hit: d20+5 — Damage: 1d8+3",
        "Dagger (20/60) — To Hit: d20+5 — Damage: 1d4+3"
      ],
      feats:[
        "Bardic Inspiration — bonus action, 3/day: give an ally a d6 to add to an attack/save/check",
        "Jack of All Trades — add +1 to any ability check you aren’t proficient in",
        "Song of Rest (d6) — during a short rest, allies heal +1d6 extra",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      spellPick:{
        mode:"known",
        choose:2,
        cantrips:["(Pick 2 bard cantrips)"],
        spells:[
          { key:"healing_word", name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + CHA HP at range." },
          { key:"dissonant_whispers", name:"Dissonant Whispers", meta:"Action • 60 ft • WIS save", desc:"Deal 3d6 psychic. Target must use its reaction to run away." },
          { key:"faerie_fire", name:"Faerie Fire", meta:"Action • 60 ft • Concentration (1 min) • DEX save", desc:"Outline creatures in light. Attacks against them have advantage, and they can’t turn invisible." },
          { key:"sleep", name:"Sleep", meta:"Action • 90 ft", desc:"Put creatures to sleep in an area. Works best on weak enemies." },
          { key:"tashas", name:"Tasha’s Hideous Laughter", meta:"Action • 30 ft • Concentration (1 min) • WIS save", desc:"Target falls prone laughing and is incapacitated until it saves." },
          { key:"detect_magic", name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." },
        ]
      },
      resources:[
        { key:"bardic_inspiration_1", name:"Bardic Inspiration (use #1)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_2", name:"Bardic Inspiration (use #2)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_3", name:"Bardic Inspiration (use #3)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
      ]
    },

    {
      id:"liora", name:"Liora Windstep", race:"Wood Elf", cls:"Ranger", level:2,
      core:{ ac:15, speed:"30 ft", init:"+3", prof:"+2", maxHp:19 },
      abilities:{ str:"+1", con:"+1", dex:"+3", wis:"+2", int:"+0", cha:"+0" },
      skills:["Stealth +5","Perception +4","Survival +4"],
      saves:["Strength +3","Dexterity +5"],
      attacks:[
        "Longbow (150/600) — To Hit: d20+5 — Damage: 1d8+3",
        "Shortsword (melee) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Fav Enemy: Undead — advantage on tracking + recalling info about undead",
        "Natural Explorer — Coastal/Forest: ignore difficult terrain and never get lost",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:2, l2:0 },
      spellPick:{
        mode:"known",
        choose:2,
        cantrips:[],
        spells:[
          { key:"hunters_mark", name:"Hunter’s Mark", meta:"Bonus Action • 90 ft • Concentration (1 hr)", desc:"Mark a target. You deal +1d6 damage each time you hit it, and you have advantage to track it." },
          { key:"cure_wounds", name:"Cure Wounds", meta:"Action • 5 ft", desc:"Heal 1d8 + WIS HP." },
          { key:"goodberry", name:"Goodberry", meta:"Action", desc:"Create 10 berries. Eating one heals 1 HP and counts as a day of food." },
          { key:"fog_cloud", name:"Fog Cloud", meta:"Action • 120 ft • Concentration (1 hr)", desc:"Create a big cloud that blocks vision. Great for escapes and saving civilians." },
          { key:"detect_magic", name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." },
          { key:"snare", name:"Snare", meta:"1 minute • 25 ft", desc:"Set a hidden trap. The first creature that steps in it must save or be restrained and lifted off the ground." },
        ]
      },
      resources:[]
    },

    {
      id:"azrael", name:"Azrael Cinderborn", race:"Tiefling", cls:"Barbarian", level:2,
      core:{ ac:15, speed:"30 ft", init:"+2", prof:"+2", maxHp:25 },
      abilities:{ str:"+4", con:"+3", dex:"+2", wis:"+0", int:"-1", cha:"+1" },
      skills:["Intimidation +3","Athletics +6","Survival +2"],
      saves:["Strength +6","Constitution +5"],
      attacks:[
        "Spear (20/60) — To Hit: d20+6 — Damage: 1d8+4",
        "Javelin (30/120) — To Hit: d20+6 — Damage: 1d6+4"
      ],
      feats:[
        "Rage (2/long rest) — bonus action, 1 min: +2 dmg on STR attacks, adv on STR checks+saves, resist B/P/S",
        "Reckless Attack — first attack each turn: advantage; enemies have advantage to hit you until next turn",
        "Danger Sense — advantage on DEX saves vs effects you can see"
      ],
      spellSlots:null,
      spellPick:null,
      resources:[
        { key:"rage_1", name:"Rage (use #1)", rest:"long", effect:"Bonus action to enter Rage. (2/Long Rest)" },
        { key:"rage_2", name:"Rage (use #2)", rest:"long", effect:"Bonus action to enter Rage. (2/Long Rest)" },
      ]
    }
  ];

  // ====== UI WIRING ======
  const select = document.getElementById("pcSelect");
  const card = document.getElementById("card");
  const el = (id)=>document.getElementById(id);

  const hpCur = el("hpCur");
  const inv = el("inv");
  const notes = el("notes");
  const conds = el("conds");

  const spellBox = el("spellBox");
  const spellHint = el("spellHint");
  const slotsL1 = el("slotsL1");
  const slotsL2 = el("slotsL2");
  const lineL1 = el("lineL1");
  const lineL2 = el("lineL2");

  const spellsKnownBox = el("spellsKnownBox");
  const spellChoosePill = el("spellChoosePill");
  const spellMeta = el("spellMeta");
  const cantripsEl = el("cantrips");
  const spellsPickEl = el("spellsPick");
  const spellFoot = el("spellFoot");

  let currentPcId = null;

  function keyFor(pcId){ return `tracker::${pcId}`; }

  function populate(){
    select.innerHTML = "";
    PCS.forEach(pc=>{
      const o = document.createElement("option");
      o.value = pc.id;
      o.textContent = pc.name;
      select.appendChild(o);
    });

    const last = localStorage.getItem("party_tracker_last_pc");
    const firstId = PCS[0]?.id;
    select.value = PCS.some(p=>p.id===last) ? last : firstId;
    render(select.value);
  }

  function setList(listElId, items){
    const ul = el(listElId);
    ul.innerHTML = "";
    (items || []).forEach(t=>{
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
  }

  function renderSlots(container, levelKey, count){
    container.innerHTML = "";
    if(!count || count <= 0) return;

    for(let i=0;i<count;i++){
      const wrap = document.createElement("div");
      wrap.className = "slot";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.slot = `${levelKey}:${i}`;
      cb.addEventListener("change", save);
      wrap.appendChild(cb);
      container.appendChild(wrap);
    }
  }

  function syncSlotVisuals(){
    document.querySelectorAll(".slot").forEach(s=>{
      const cb = s.querySelector("input");
      s.classList.toggle("on", !!cb.checked);
    });
  }

  function updateHpPill(){
    const pc = PCS.find(p=>p.id===currentPcId);
    const maxHp = pc?.core?.maxHp ?? "—";
    const cur = hpCur.value || "—";
    el("hpPill").textContent = `HP: ${cur} / ${maxHp}`;
  }

  // ===== RESOURCES MODULE =====
  const ResourcesModule = (() => {
    const resourcesEl = el("resources");

    function build(pc){
      resourcesEl.innerHTML = "";
      const res = Array.isArray(pc.resources) ? pc.resources : [];
      if(res.length === 0){
        resourcesEl.innerHTML = `<div class="muted">—</div>`;
        return;
      }

      res.forEach(r=>{
        const row = document.createElement("div");
        row.className = "checkrow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.dataset.resource = r.key;
        cb.addEventListener("change", save);

        const text = document.createElement("div");
        text.innerHTML = `<div class="title">${r.name} <span class="muted">(${r.rest} rest)</span></div>
                          <div class="desc">${r.effect}</div>`;

        const info = document.createElement("button");
        info.className = "infoBtn";
        info.type = "button";
        info.textContent = "?";
        info.addEventListener("click", ()=>{
          alert(`${r.name}\n\n${r.effect}\n\nResets on: ${r.rest} rest`);
        });

        row.appendChild(cb);
        row.appendChild(text);
        row.appendChild(info);
        resourcesEl.appendChild(row);
      });
    }

    return { build };
  })();

  // ===== SPELLS DISPLAY + PICK =====
  function buildSpells(pc){
    const sp = pc.spellPick;
    if(!sp){
      spellsKnownBox.hidden = true;
      cantripsEl.innerHTML = "";
      spellsPickEl.innerHTML = "";
      spellMeta.textContent = "";
      spellFoot.textContent = "";
      return;
    }

    spellsKnownBox.hidden = false;

    // Cantrips list (display only)
    cantripsEl.innerHTML = "";
    (sp.cantrips || []).forEach(c=>{
      const li = document.createElement("li");
      li.textContent = c;
      cantripsEl.appendChild(li);
    });
    if(!(sp.cantrips || []).length){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "—";
      cantripsEl.appendChild(li);
    }

    // Spells (checkbox pick)
    spellsPickEl.innerHTML = "";
    const chooseN = sp.choose ?? 0;
    const modeLabel = sp.mode === "prepare" ? "Prepared spells" : "Spells known";
    spellMeta.textContent = `${modeLabel}: choose ${chooseN}` + (pc.spellSlots ? ` • Slots: L1 ${pc.spellSlots.l1 || 0}` : "");
    spellChoosePill.textContent = `Choose ${chooseN}`;

    (sp.spells || []).forEach(s=>{
      const row = document.createElement("div");
      row.className = "spellItem";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.spellpick = s.key;
      cb.addEventListener("change", ()=>{
        enforceSpellPickLimit(chooseN);
        save();
      });

      const text = document.createElement("div");
      text.innerHTML = `<div class="title">${s.name}</div>
                        <div class="meta">${s.meta || ""}</div>
                        <div class="desc">${s.desc || ""}</div>`;

      row.appendChild(cb);
      row.appendChild(text);
      spellsPickEl.appendChild(row);
    });

    spellFoot.textContent = "Tap spells to select your list. Auto-saves on this device.";
  }

  function enforceSpellPickLimit(chooseN){
    if(!chooseN || chooseN <= 0) return;

    const picks = Array.from(document.querySelectorAll('[data-spellpick]'));
    const checked = picks.filter(x=>x.checked);

    if(checked.length <= chooseN) return;

    // If over limit, undo the most recent change by unchecking the last one that triggered
    // (We don’t know which was last reliably; simplest: uncheck the last checked in DOM order.)
    const last = checked[checked.length - 1];
    last.checked = false;
    alert(`You can only choose ${chooseN} spell(s) for this character.`);
  }

  function load(){
    if(!currentPcId) return;

    const pc = PCS.find(p=>p.id===currentPcId);
    const raw = localStorage.getItem(keyFor(currentPcId));

    // Defaults
    if(!raw){
      hpCur.value = pc?.core?.maxHp ?? "";
      inv.value = "";
      notes.value = "";
      conds.value = "";

      // clear slots/resources/spells
      document.querySelectorAll(".slot input").forEach(cb=>cb.checked=false);
      document.querySelectorAll("[data-resource]").forEach(cb=>cb.checked=false);
      document.querySelectorAll("[data-spellpick]").forEach(cb=>cb.checked=false);

      syncSlotVisuals();
      updateHpPill();
      return;
    }

    try{
      const st = JSON.parse(raw);
      hpCur.value = st.hpCur ?? (pc?.core?.maxHp ?? "");
      inv.value = st.inv ?? "";
      notes.value = st.notes ?? "";
      conds.value = st.conds ?? "";

      // slots
      const slotState = st.slots || {};
      document.querySelectorAll(".slot input").forEach(cb=>{
        cb.checked = !!slotState[cb.dataset.slot];
      });

      // resources
      const resState = st.resources || {};
      document.querySelectorAll("[data-resource]").forEach(cb=>{
        cb.checked = !!resState[cb.dataset.resource];
      });

      // spells pick
      const spellPickState = st.spellPick || {};
      document.querySelectorAll("[data-spellpick]").forEach(cb=>{
        cb.checked = !!spellPickState[cb.dataset.spellpick];
      });

      syncSlotVisuals();
      updateHpPill();
    }catch{
      hpCur.value = pc?.core?.maxHp ?? "";
      updateHpPill();
    }
  }

  function save(){
    if(!currentPcId) return;

    const slotState = {};
    document.querySelectorAll(".slot input").forEach(cb=>{
      slotState[cb.dataset.slot] = !!cb.checked;
    });

    const resState = {};
    document.querySelectorAll("[data-resource]").forEach(cb=>{
      resState[cb.dataset.resource] = !!cb.checked;
    });

    const spellPickState = {};
    document.querySelectorAll("[data-spellpick]").forEach(cb=>{
      spellPickState[cb.dataset.spellpick] = !!cb.checked;
    });

    const st = {
      hpCur: hpCur.value,
      inv: inv.value,
      notes: notes.value,
      conds: conds.value,
      slots: slotState,
      resources: resState,
      spellPick: spellPickState
    };

    localStorage.setItem(keyFor(currentPcId), JSON.stringify(st));
    syncSlotVisuals();
    updateHpPill();
  }

  function render(id){
    const pc = PCS.find(p=>p.id===id);
    if(!pc) return;

    currentPcId = id;
    localStorage.setItem("party_tracker_last_pc", id);
    card.hidden = false;

    el("name").textContent = pc.name;
    el("sub").textContent = `${pc.race} • ${pc.cls}`;

    el("level").textContent = pc.level ?? "—";
    el("race").textContent  = pc.race ?? "—";
    el("cls").textContent   = pc.cls ?? "—";

    el("ac").textContent    = pc.core?.ac ?? "—";
    el("speed").textContent = pc.core?.speed ?? "—";
    el("init").textContent  = pc.core?.init ?? "—";
    el("prof").textContent  = pc.core?.prof ?? "—";
    el("maxhp").textContent = pc.core?.maxHp ?? "—";

    el("str").textContent = pc.abilities?.str ?? "—";
    el("dex").textContent = pc.abilities?.dex ?? "—";
    el("con").textContent = pc.abilities?.con ?? "—";
    el("int").textContent = pc.abilities?.int ?? "—";
    el("wis").textContent = pc.abilities?.wis ?? "—";
    el("cha").textContent = pc.abilities?.cha ?? "—";

    setList("skills", pc.skills);
    setList("saves", pc.saves);
    setList("attacks", pc.attacks);
    setList("feats", pc.feats);

    // spell slots
    if(pc.spellSlots){
      spellBox.hidden = false;
      const l1 = pc.spellSlots.l1 || 0;
      const l2 = pc.spellSlots.l2 || 0;

      spellHint.textContent = `Level 1: ${l1} slot(s)` + (l2 ? ` • Level 2: ${l2} slot(s)` : "");
      lineL1.hidden = (l1 <= 0);
      lineL2.hidden = (l2 <= 0);

      renderSlots(slotsL1, "L1", l1);
      renderSlots(slotsL2, "L2", l2);
    }else{
      spellBox.hidden = true;
      slotsL1.innerHTML = "";
      slotsL2.innerHTML = "";
    }

    ResourcesModule.build(pc);
    buildSpells(pc);

    load();

    // enforce after load (in case older state exceeds choose count)
    if(pc.spellPick?.choose){
      enforceSpellPickLimit(pc.spellPick.choose);
      save();
    }
  }

  function doShortRest(){
    if(!currentPcId) return;
    const pc = PCS.find(p=>p.id===currentPcId);
    if(!pc) return;

    // Uncheck all resources that reset on short rest
    document.querySelectorAll("[data-resource]").forEach(cb=>{
      const rKey = cb.dataset.resource;
      const res = (pc.resources||[]).find(r=>r.key===rKey);
      if(res?.rest === "short") cb.checked = false;
    });

    save();
    alert("Short Rest applied:\n- Short-rest resources reset.\n- Spell slots unchanged.");
  }

  function doLongRest(){
    if(!currentPcId) return;
    const pc = PCS.find(p=>p.id===currentPcId);
    if(!pc) return;

    // Reset ALL resources
    document.querySelectorAll("[data-resource]").forEach(cb=>cb.checked=false);

    // Reset spell slots
    document.querySelectorAll(".slot input").forEach(cb=>cb.checked=false);

    // Optionally restore HP
    const restore = confirm("Long Rest applied.\n\nRestore HP to max?");
    if(restore){
      hpCur.value = pc.core?.maxHp ?? hpCur.value;
    }

    save();
    alert("Long Rest applied:\n- Resources reset\n- Spell slots reset\n- HP " + (restore ? "restored to max" : "unchanged"));
  }

  // ===== events =====
  select.addEventListener("change", () => render(select.value));
  [hpCur, inv, notes, conds].forEach(x => x.addEventListener("input", save));

  document.getElementById("resetThis").addEventListener("click", ()=>{
    if(!currentPcId) return;
    if(confirm("Reset this PC on THIS device?")){
      localStorage.removeItem(keyFor(currentPcId));
      render(currentPcId);
    }
  });

  document.getElementById("shortRest").addEventListener("click", doShortRest);
  document.getElementById("longRest").addEventListener("click", doLongRest);

  populate();
</script>
</body>
</html>
