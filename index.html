<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crystal Faire — Party Tracker</title>
  <style>
    :root{
      --bg:#0f0c0a;
      --ink:#f4efe7;
      --muted:#cbbca7;
      --line:rgba(255,255,255,.14);
      --accent: rgba(42,166,164,.9);
      --danger: rgba(192,57,43,.35);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
                  linear-gradient(180deg, #241a12, var(--bg));
      padding: 16px;
    }
    .wrap{max-width:1180px;margin:0 auto;}
    h1{margin:0 0 10px;font-size:20px;letter-spacing:.2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 14px;}
    select{
      flex: 1 1 280px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--ink);
      font-weight: 950;
    }
    .btn{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight: 950;
      cursor:pointer;
    }
    .btn:hover{background: rgba(255,255,255,.12)}
    .btn.danger{border-color: rgba(192,57,43,.55); background: rgba(192,57,43,.18)}
    .btn.danger:hover{background: rgba(192,57,43,.26)}
    .card{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
    }

    .head{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:10px;
    }
    .token{
      width:56px;height:56px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color: rgba(255,255,255,.75);
    }
    .token img{width:100%;height:100%;object-fit:cover;display:block}

    .name{font-size:22px;font-weight:1000;margin:0 0 4px}
    .sub{color:var(--muted);font-weight:850;margin:0}

    /* ===== NEW: 3-column grid + row bands ===== */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }

    .rowband{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:980px){
      .rowband{grid-template-columns:1fr;}
    }

    .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--muted);
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.10);}
    .kv:last-child{border-bottom:none;}
    .k{color:rgba(244,239,231,.9); font-weight:900;}
    .v{color:rgba(244,239,231,.95); font-weight:1000;}

    ul{margin:0; padding-left:18px}
    li{margin:6px 0}

    .muted{color:var(--muted); font-weight:800}

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width:980px){ .inputs{grid-template-columns:1fr;} }

    input[type="number"], textarea{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      padding: 10px 12px;
      font-size: 15px;
      outline:none;
    }
    textarea{min-height:110px; resize: vertical;}
    .label{font-weight:950; margin: 0 0 6px; color: rgba(244,239,231,.92)}
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 1000;
      color: rgba(244,239,231,.95);
    }

    .slotsWrap{margin-top:8px}
    .slotsLine{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin: 8px 0;}
    .slotsLabel{min-width:92px; font-weight:950; color: rgba(244,239,231,.92)}
    .slots{display:flex; gap:8px; flex-wrap:wrap;}
    .slot{
      width: 18px; height: 18px;
      border-radius: 6px;
      border: 2px solid var(--accent);
      background: rgba(255,255,255,.12);
      transform: rotate(45deg);
      position: relative;
    }
    .slot input{position:absolute; inset:0; opacity:0;}
    .slot.on{background: var(--accent);}

    .resources{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .checkrow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 10px 10px;
    }
    .checkrow input[type="checkbox"]{transform: scale(1.2); margin-top: 2px;}
    .checkrow .title{font-weight:1000}
    .checkrow .desc{color: rgba(255,255,255,.78); font-weight:750; margin-top:2px; line-height:1.25}

    .infoBtn{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      color:#fff;
      width:28px; height:28px;
      border-radius: 10px;
      font-weight: 1000;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .infoBtn:hover{background: rgba(255,255,255,.12)}
    .foot{
      margin-top:12px;
      color:rgba(255,255,255,.75);
      font-size:12px;
      line-height:1.35
    }

    .pickHint{font-size:12px;color:rgba(255,255,255,.75);font-weight:800;margin-bottom:8px}
    .spellGrid{display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px}
    .spellItem{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 10px 10px;
    }
    .spellTop{display:flex; gap:10px; align-items:flex-start}
    .spellTop input{transform: scale(1.2); margin-top: 2px;}
    .spellName{font-weight:1000}
    .spellMeta{color:rgba(255,255,255,.75);font-weight:850;font-size:12px;margin-top:2px}
    .spellDesc{color: rgba(255,255,255,.82); font-weight:750; margin-top:6px; line-height:1.25}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Crystal Faire — Party Tracker</h1>

  <div class="row">
    <select id="pcSelect" aria-label="Select a character"></select>
    <button class="btn" id="shortRest">Short Rest</button>
    <button class="btn" id="longRest">Long Rest</button>
    <button class="btn danger" id="resetThis">Reset This PC (this device)</button>
  </div>

  <div class="card" id="card" hidden>
    <div class="head">
      <div class="token" id="tokenBox"><span>—</span></div>
      <div>
        <p class="name" id="name"></p>
        <p class="sub" id="sub"></p>
      </div>
    </div>

    <div class="grid">

      <!-- ROW 1: Session Tracker | Actions | About -->
      <div class="rowband">

        <!-- 1A: SESSION TRACKER (spell slots embedded) -->
        <div class="box">
          <h3>Session Tracker</h3>

          <div class="inputs">
            <div>
              <div class="label">Current HP</div>
              <input type="number" id="hpCur" min="0" step="1" />
              <div style="margin-top:10px">
                <span class="pill" id="hpPill">HP: —</span>
              </div>
            </div>

            <div>
              <div class="label">Inventory</div>
              <textarea id="inv" placeholder="Loot, gear, items..."></textarea>
            </div>

            <div>
              <div class="label">Notes</div>
              <textarea id="notes" placeholder="Clues, NPCs, plans..."></textarea>
            </div>

            <div>
              <div class="label">Conditions / Reminders</div>
              <textarea id="conds" placeholder="Exhaustion level, Rage uses, Inspiration, etc."></textarea>
            </div>
          </div>

          <!-- EMBEDDED SPELL SLOTS -->
          <div id="spellSlotsInline" style="margin-top:12px" hidden>
            <div class="label">Spell Slots</div>
            <div class="muted" id="spellHint"></div>
            <div class="slotsWrap">
              <div class="slotsLine" id="lineL1" hidden>
                <div class="slotsLabel">Level 1</div>
                <div class="slots" id="slotsL1"></div>
              </div>
              <div class="slotsLine" id="lineL2" hidden>
                <div class="slotsLabel">Level 2</div>
                <div class="slots" id="slotsL2"></div>
              </div>
            </div>
            <div class="foot">Tap diamonds to mark used slots. (Spell slots reset on Long Rest.)</div>
          </div>

          <div style="margin-top:12px">
            <div class="label">Resources (tap to mark used)</div>
            <div class="resources" id="resources"></div>
          </div>

          <div class="foot">Auto-saves on this device.</div>
        </div>

        <!-- 1B: ACTIONS (attacks, class feats, spells/cantrips) -->
        <div class="box">
          <h3>Actions</h3>

          <div style="margin-top:6px">
            <div class="label">Attacks</div>
            <ul id="attacks"></ul>
          </div>

          <div style="margin-top:12px">
            <div class="label">Class Feats</div>
            <ul id="feats"></ul>
          </div>

          <!-- Spells & Cantrips -->
          <div class="box" id="magicBox" hidden style="margin-top:12px">
            <h3>Spells & Cantrips</h3>

            <div id="cantripSection" hidden>
              <div class="pickHint" id="cantripHint"></div>
              <div class="spellGrid" id="cantripList"></div>
            </div>

            <div id="spellSection" style="margin-top:12px" hidden>
              <div class="pickHint" id="spellPickHint"></div>
              <div class="spellGrid" id="spellList"></div>
            </div>

            <div class="foot">Selections save per-character on this device.</div>
          </div>
        </div>

        <!-- 1C: ABOUT (core, abilities, saves, skills) -->
        <div class="box">
          <h3>About</h3>

          <div class="kv"><div class="k">Level</div><div class="v" id="level"></div></div>
          <div class="kv"><div class="k">Race</div><div class="v" id="race"></div></div>
          <div class="kv"><div class="k">Class</div><div class="v" id="cls"></div></div>
          <div class="kv"><div class="k">AC</div><div class="v" id="ac"></div></div>
          <div class="kv"><div class="k">Speed</div><div class="v" id="speed"></div></div>
          <div class="kv"><div class="k">Init</div><div class="v" id="init"></div></div>
          <div class="kv"><div class="k">Prof</div><div class="v" id="prof"></div></div>
          <div class="kv"><div class="k">Max HP</div><div class="v" id="maxhp"></div></div>

          <div style="margin-top:12px" class="muted">Abilities</div>
          <div class="kv"><div class="k">STR</div><div class="v" id="str"></div></div>
          <div class="kv"><div class="k">DEX</div><div class="v" id="dex"></div></div>
          <div class="kv"><div class="k">CON</div><div class="v" id="con"></div></div>
          <div class="kv"><div class="k">INT</div><div class="v" id="int"></div></div>
          <div class="kv"><div class="k">WIS</div><div class="v" id="wis"></div></div>
          <div class="kv"><div class="k">CHA</div><div class="v" id="cha"></div></div>

          <div style="margin-top:12px">
            <div class="label">Saves</div>
            <ul id="saves"></ul>
          </div>

          <div style="margin-top:12px">
            <div class="label">Skills</div>
            <ul id="skills"></ul>
          </div>
        </div>

      </div><!-- /rowband -->

      <!-- (Future rows can go here as additional <div class="rowband">...</div> blocks) -->

    </div><!-- /grid -->
  </div><!-- /card -->
</div><!-- /wrap -->

<script>
  // ===== PARTY DATA =====
  // Note: "spellSlots" controls the diamond slots UI.
  // "magic" controls spell/cantrip lists + pick limits.
  const PCS = [
    {
      id:"seris", name:"Seris Dawnblade", race:"Human", cls:"Fighter", level:2,
      token:null, // e.g. "tokens/seris.png"
      core:{ ac:16, speed:"30 ft", init:"+1", prof:"+2", maxHp:20 },
      abilities:{ str:"+3", con:"+2", dex:"+1", wis:"+1", int:"+0", cha:"+1" },
      skills:["Athletics +5","Perception +3","Intimidation +3"],
      saves:["Strength +5","Constitution +4"],
      attacks:["Longsword (melee) — To Hit: d20+5 — Damage: 1d8+5"],
      feats:["Second Wind — regain 1d10+2 HP (1/short rest)","Fight Style: Dueling — while using one-handed melee weapon and no other weapons, deal +2 damage","Action Surge — take one extra action (1/short rest)"],
      spellSlots:null,
      magic:null,
      resources:[
        { key:"second_wind", name:"Second Wind", rest:"short", effect:"Regain 1d10+2 HP. (1/Short Rest)" },
        { key:"action_surge", name:"Action Surge", rest:"short", effect:"Take one extra action on your turn. (1/Short Rest)" },
      ]
    },
    {
      id:"sable", name:"Sable Thornscar", race:"Tiefling", cls:"Fighter", level:2,
      token:null,
      core:{ ac:16, speed:"30 ft", init:"+2", prof:"+2", maxHp:21 },
      abilities:{ str:"+3", con:"+2", dex:"+2", wis:"+0", int:"+0", cha:"+1" },
      skills:["Intimidation +3","Athletics +5","Perception +2"],
      saves:["Strength +5","Constitution +4"],
      attacks:[
        "Greatsword (melee) — To Hit: d20+5 — Damage: 2d6+3",
        "Handaxe (20/60) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Second Wind — regain 1d10+2 HP (1/short rest)",
        "Fight Style: Great Weapon Fighting — reroll 1s/2s on damage dice",
        "Action Surge — take one extra action (1/short rest)"
      ],
      spellSlots:null,
      magic:null,
      resources:[
        { key:"second_wind", name:"Second Wind", rest:"short", effect:"Regain 1d10+2 HP. (1/Short Rest)" },
        { key:"action_surge", name:"Action Surge", rest:"short", effect:"Take one extra action on your turn. (1/Short Rest)" },
      ]
    },
    {
      id:"korrin", name:"Korrin Ashfang", race:"Half-Orc", cls:"Rogue", level:2,
      token:null,
      core:{ ac:14, speed:"30 ft", init:"+3", prof:"+2", maxHp:18 },
      abilities:{ str:"+2", con:"+2", dex:"+3", wis:"+1", int:"+0", cha:"+0" },
      skills:["Stealth +5","Perception +3","Acrobatics +5"],
      saves:["Dexterity +5","Intelligence +2"],
      attacks:[
        "Shortsword (melee) — To Hit: d20+5 — Damage: 1d6+3",
        "Shortbow (80/320) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Sneak Attack (1/turn) — advantage OR ally adjacent: +1d6 damage",
        "Cunning Action — Dash/Disengage/Hide as bonus action"
      ],
      spellSlots:null,
      magic:null,
      resources:[]
    },
    {
      id:"haldor", name:"Haldor Brightshield", race:"Dwarf", cls:"Cleric (Life Domain)", level:2,
      token:null,
      core:{ ac:18, speed:"25 ft", init:"+0", prof:"+2", maxHp:18 },
      abilities:{ str:"+2", con:"+3", dex:"+0", wis:"+3", int:"+0", cha:"+1" },
      skills:["Medicine +5","Perception +5","Insight +5"],
      saves:["Wisdom +5","Charisma +3"],
      attacks:[
        "Warhammer (melee) — To Hit: d20+4 — Damage: 1d8+2",
        "Light Xbow (80/320) — To Hit: d20+2 — Damage: 1d8"
      ],
      feats:[
        "Disciple of Life — healing spells restore + (2 + spell level) extra HP",
        "Channel Divinity (1/short rest): Turn Undead OR Preserve Life (split 10 HP within 30 ft)",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      magic:{
        cantripPick:3,
        cantrips:[
          { name:"Guidance", meta:"Action • Touch • Concentration (1 min)", desc:"Add +1d4 to one ability check the target makes." },
          { name:"Sacred Flame", meta:"Action • 60 ft • DEX save", desc:"Target makes a DEX save or takes 1d8 radiant damage." },
          { name:"Spare the Dying", meta:"Action • Touch", desc:"A creature at 0 HP becomes stable." },
          { name:"Light", meta:"Action • Touch • 1 hour", desc:"Object sheds bright light 20 ft and dim light 20 ft more." },
          { name:"Thaumaturgy", meta:"Action • 30 ft • 1 min", desc:"Minor divine wonders: booming voice, flickering flames, tremors, etc." },
          { name:"Resistance", meta:"Action • Touch • Concentration (1 min)", desc:"Add 1d4 to one saving throw of the target." }
        ],
        spellPick:4,
        spells:[
          { name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Up to 3 allies add +1d4 to attack rolls and saving throws." },
          { name:"Cure Wounds", meta:"Action • Touch", desc:"Heal 1d8 + WIS HP." },
          { name:"Protection from Evil and Good", meta:"Action • Touch • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations; they have disadvantage to hit; target can’t be charmed/frightened/possessed by them." },
          { name:"Guiding Bolt", meta:"Action • 120 ft", desc:"Ranged radiant attack (your sheet: 4d6). Next attack against target has advantage." },
          { name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + WIS HP at range." },
          { name:"Sanctuary", meta:"Bonus Action • 30 ft • 1 min", desc:"Protect an ally: enemies must pass a WIS save to attack them or choose a new target." }
        ]
      },
      resources:[
        { key:"channel_divinity", name:"Channel Divinity", rest:"short", effect:"Choose Turn Undead or Preserve Life. (1/Short Rest)" },
      ]
    },
    {
      id:"ashara", name:"Ashara Solkindle", race:"Fire Genasi", cls:"Cleric (Life Domain)", level:2,
      token:null,
      core:{ ac:16, speed:"30 ft", init:"+0", prof:"+2", maxHp:18 },
      abilities:{ str:"+1", con:"+2", dex:"+1", wis:"+3", int:"+0", cha:"+1" },
      skills:["Medicine +5","Perception +5","Insight +5"],
      saves:["Wisdom +5","Charisma +3"],
      attacks:["Staff (melee) — To Hit: d20+3 — Damage: 1d8+1"],
      feats:[
        "Disciple of Life — healing spells restore + (2 + spell level) extra HP",
        "Channel Divinity (1/short rest): Turn Undead OR Preserve Life (split 10 HP within 30 ft)",
        "Warm Hands (1/short rest) — touch a creature to end shivering/fear",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      magic:{
        cantripPick:3,
        cantrips:[
          { name:"Sacred Flame", meta:"Action • 60 ft • DEX save", desc:"Target makes a DEX save or takes 1d8 radiant damage." },
          { name:"Guidance", meta:"Action • Touch • Concentration (1 min)", desc:"Add +1d4 to one ability check the target makes." },
          { name:"Spare the Dying", meta:"Action • Touch", desc:"A creature at 0 HP becomes stable." }
        ],
        spellPick:4,
        spells:[
          { name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Up to 3 allies add +1d4 to attack rolls and saving throws." },
          { name:"Cure Wounds", meta:"Action • Touch", desc:"Heal 1d8 + WIS HP." },
          { name:"Protection from Evil and Good", meta:"Action • Touch • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations; they have disadvantage to hit; target can’t be charmed/frightened/possessed by them." },
          { name:"Guiding Bolt", meta:"Action • 120 ft", desc:"Ranged radiant attack (your sheet: 4d6). Next attack against target has advantage." },
          { name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + WIS HP at range." },
          { name:"Sanctuary", meta:"Bonus Action • 30 ft • 1 min", desc:"Protect an ally: enemies must pass a WIS save to attack them or choose a new target." }
        ]
      },
      resources:[
        { key:"channel_divinity", name:"Channel Divinity", rest:"short", effect:"Choose Turn Undead or Preserve Life. (1/Short Rest)" },
        { key:"warm_hands", name:"Warm Hands", rest:"short", effect:"Touch a creature to end shivering/fear. (1/Short Rest)" },
      ]
    },
    {
      id:"edrin", name:"Edrin Valebright", race:"Human", cls:"Paladin", level:2,
      token:null,
      core:{ ac:19, speed:"30 ft", init:"+0", prof:"+2", maxHp:20 },
      abilities:{ str:"+3", con:"+2", dex:"+0", wis:"+1", int:"+0", cha:"+2" },
      skills:["Athletics +5","Persuasion +4","Insight +3"],
      saves:["Wisdom +3","Charisma +4"],
      attacks:["Longsword (melee) — To Hit: d20+5 — Damage: 1d8+3"],
      feats:[
        "Lay on Hands — heal from a pool of 10 HP / long rest",
        "Divine Smite — spend a spell slot on a hit for +2d8 radiant (+1d8 vs undead/fiends)",
        "Defense (Fighting Style) — AC +1 (already added)",
        "Spellcasting"
      ],
      spellSlots:{ l1:2, l2:0 },
      magic:{
        cantripPick:0,
        cantrips:[],
        spellPick:3,
        spells:[
          { name:"Bless", meta:"Action • 30 ft • Concentration", desc:"Up to 3 allies add +1d4 to attack rolls and saving throws." },
          { name:"Command", meta:"Action • 60 ft • 1 round • WIS save", desc:"Speak a 1-word command (Drop, Flee, Halt, etc.). On a failed save, target obeys on its next turn." },
          { name:"Cure Wounds", meta:"Action • Touch", desc:"Heal 1d8 + CHA HP (your sheet text)." },
          { name:"Protection from Evil and Good", meta:"Action • Touch • Concentration (10 min)", desc:"Protection vs undead/fiends/celestials/fey/elementals/aberrations; they have disadvantage to hit; target can’t be charmed/frightened/possessed by them." },
          { name:"Shield of Faith", meta:"Bonus Action • Self • Concentration (1 min)", desc:"Give a creature +2 AC." }
        ]
      },
      resources:[
        { key:"lay_on_hands", name:"Lay on Hands (10 HP pool)", rest:"long", effect:"You have a 10 HP pool per long rest. Spend any amount as an action to heal." },
      ]
    },
    {
      id:"rurik", name:"Rurik Goldnote", race:"Dwarf", cls:"Bard", level:2,
      token:null,
      core:{ ac:14, speed:"25 ft", init:"+1", prof:"+2", maxHp:17 },
      abilities:{ str:"+1", con:"+2", dex:"+1", wis:"+0", int:"+1", cha:"+3" },
      skills:["Persuasion +5","Performance +5","History +3"],
      saves:["Dexterity +3","Charisma +5"],
      attacks:[
        "Rapier (melee) — To Hit: d20+3 — Damage: 1d8+1",
        "Dagger (20/60) — To Hit: d20+3 — Damage: 1d4+1"
      ],
      feats:[
        "Bardic Inspiration — bonus action, 3/day: give an ally a d6 to add to an attack/save/check",
        "Jack of All Trades — add +1 to any ability check you aren’t proficient in",
        "Song of Rest (d6) — during a short rest, allies heal +1d6 extra",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      magic:{
        cantripPick:2,
        cantrips:[
          { name:"Dancing Lights", meta:"Action • 120 ft • Concentration (1 min)", desc:"Create up to 4 lights; can combine into one glowing form." },
          { name:"Light", meta:"Action • Touch • 1 hour", desc:"Object sheds bright light 20 ft and dim light 20 ft more." },
          { name:"Mage Hand", meta:"Action • 30 ft • 1 min", desc:"Spectral hand manipulates objects (no attacks)." },
          { name:"Mending", meta:"1 minute • Touch", desc:"Repairs a single break/tear in an object." },
          { name:"Message", meta:"Action • 120 ft", desc:"Whisper to a creature; it can reply in a whisper." },
          { name:"Minor Illusion", meta:"Action • 30 ft • 1 min", desc:"Create a sound or image illusion." },
          { name:"Prestidigitation", meta:"Action • 10 ft • 1 hour", desc:"Minor magical tricks: clean, flavor, mark, chill/warm, etc." },
          { name:"True Strike", meta:"Action • 30 ft • Concentration (1 round)", desc:"Gain advantage on your next attack vs target." },
          { name:"Vicious Mockery", meta:"Action • 60 ft • WIS save", desc:"Target takes psychic damage and has disadvantage on its next attack." }
        ],
        spellPick:2,
        spells:[
          { name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + CHA HP at range." },
          { name:"Dissonant Whispers", meta:"Action • 60 ft • WIS save", desc:"Deal 3d6 psychic. Target must use its reaction to run away." },
          { name:"Faerie Fire", meta:"Action • 60 ft • Concentration (1 min) • DEX save", desc:"Outline creatures in light; attacks against them have advantage; they can’t turn invisible." },
          { name:"Sleep", meta:"Action • 90 ft", desc:"Put creatures to sleep in an area. Works best on weak enemies." },
          { name:"Tasha’s Hideous Laughter", meta:"Action • 30 ft • Concentration (1 min) • WIS save", desc:"Target falls prone laughing and is incapacitated until it saves." },
          { name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." }
        ]
      },
      resources:[
        { key:"bardic_inspiration_1", name:"Bardic Inspiration (use #1)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_2", name:"Bardic Inspiration (use #2)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_3", name:"Bardic Inspiration (use #3)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
      ]
    },
    {
      id:"lark", name:"Lark Thistledown", race:"Halfling", cls:"Bard", level:2,
      token:null,
      core:{ ac:14, speed:"25 ft", init:"+3", prof:"+2", maxHp:15 },
      abilities:{ str:"-1", con:"+1", dex:"+3", wis:"+1", int:"+0", cha:"+3" },
      skills:["Deception +5","Stealth +5","Perception +3"],
      saves:["Dexterity +5","Charisma +5"],
      attacks:[
        "Rapier (melee) — To Hit: d20+5 — Damage: 1d8+3",
        "Dagger (20/60) — To Hit: d20+5 — Damage: 1d4+3"
      ],
      feats:[
        "Bardic Inspiration — bonus action, 3/day: give an ally a d6 to add to an attack/save/check",
        "Jack of All Trades — add +1 to any ability check you aren’t proficient in",
        "Song of Rest (d6) — during a short rest, allies heal +1d6 extra",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:3, l2:0 },
      magic:{
        cantripPick:2,
        cantrips:[
          { name:"Dancing Lights", meta:"Action • 120 ft • Concentration (1 min)", desc:"Create up to 4 lights; can combine into one glowing form." },
          { name:"Light", meta:"Action • Touch • 1 hour", desc:"Object sheds bright light 20 ft and dim light 20 ft more." },
          { name:"Mage Hand", meta:"Action • 30 ft • 1 min", desc:"Spectral hand manipulates objects (no attacks)." },
          { name:"Mending", meta:"1 minute • Touch", desc:"Repairs a single break/tear in an object." },
          { name:"Message", meta:"Action • 120 ft", desc:"Whisper to a creature; it can reply in a whisper." },
          { name:"Minor Illusion", meta:"Action • 30 ft • 1 min", desc:"Create a sound or image illusion." },
          { name:"Prestidigitation", meta:"Action • 10 ft • 1 hour", desc:"Minor magical tricks: clean, flavor, mark, chill/warm, etc." },
          { name:"True Strike", meta:"Action • 30 ft • Concentration (1 round)", desc:"Gain advantage on your next attack vs target." },
          { name:"Vicious Mockery", meta:"Action • 60 ft • WIS save", desc:"Target takes psychic damage and has disadvantage on its next attack." }
        ],
        spellPick:2,
        spells:[
          { name:"Healing Word", meta:"Bonus Action • 60 ft", desc:"Heal 1d4 + CHA HP at range." },
          { name:"Dissonant Whispers", meta:"Action • 60 ft • WIS save", desc:"Deal 3d6 psychic. Target must use its reaction to run away." },
          { name:"Faerie Fire", meta:"Action • 60 ft • Concentration (1 min) • DEX save", desc:"Outline creatures in light; attacks against them have advantage; they can’t turn invisible." },
          { name:"Sleep", meta:"Action • 90 ft", desc:"Put creatures to sleep in an area. Works best on weak enemies." },
          { name:"Tasha’s Hideous Laughter", meta:"Action • 30 ft • Concentration (1 min) • WIS save", desc:"Target falls prone laughing and is incapacitated until it saves." },
          { name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." }
        ]
      },
      resources:[
        { key:"bardic_inspiration_1", name:"Bardic Inspiration (use #1)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_2", name:"Bardic Inspiration (use #2)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
        { key:"bardic_inspiration_3", name:"Bardic Inspiration (use #3)", rest:"long", effect:"Give an ally a d6 to add to an attack/save/check. (3/day)" },
      ]
    },
    {
      id:"liora", name:"Liora Windstep", race:"Wood Elf", cls:"Ranger", level:2,
      token:null,
      core:{ ac:15, speed:"30 ft", init:"+3", prof:"+2", maxHp:19 },
      abilities:{ str:"+1", con:"+1", dex:"+3", wis:"+2", int:"+0", cha:"+0" },
      skills:["Stealth +5","Perception +4","Survival +4"],
      saves:["Strength +3","Dexterity +5"],
      attacks:[
        "Longbow (150/600) — To Hit: d20+5 — Damage: 1d8+3",
        "Shortsword (melee) — To Hit: d20+5 — Damage: 1d6+3"
      ],
      feats:[
        "Fav Enemy: Undead — advantage on tracking + recalling info about undead",
        "Natural Explorer — Coastal/Forest: ignore difficult terrain and never get lost",
        "Spellcasting (Lvl 2)"
      ],
      spellSlots:{ l1:2, l2:0 },
      magic:{
        cantripPick:0,
        cantrips:[],
        spellPick:2,
        spells:[
          { name:"Hunter’s Mark", meta:"Bonus Action • 90 ft • Concentration (1 hour)", desc:"Mark a target. You deal +1d6 damage each time you hit it and you have advantage to track it." },
          { name:"Cure Wounds", meta:"Action • Touch", desc:"Heal 1d8 + WIS HP." },
          { name:"Goodberry", meta:"Action", desc:"Create 10 berries. Eating one heals 1 HP and counts as a day of food." },
          { name:"Fog Cloud", meta:"Action • 120 ft • Concentration (1 hour)", desc:"Create a big cloud that blocks vision. Great for escapes and saving civilians" },
          { name:"Detect Magic", meta:"Action • Self • Concentration (10 min)", desc:"Sense magic within 30 ft." },
          { name:"Snare", meta:"1 minute • 25 ft", desc:"Set a hidden trap. The first creature that steps in it must save or be restrained and lifted off the ground." }
        ]
      },
      resources:[]
    },
    {
      id:"azrael", name:"Azrael Cinderborn", race:"Tiefling", cls:"Barbarian", level:2,
      token:null,
      core:{ ac:15, speed:"30 ft", init:"+2", prof:"+2", maxHp:25 },
      abilities:{ str:"+4", con:"+3", dex:"+2", wis:"+0", int:"-1", cha:"+1" },
      skills:["Intimidation +3","Athletics +6","Survival +2"],
      saves:["Strength +6","Constitution +5"],
      attacks:[
        "Spear (20/60) — To Hit: d20+6 — Damage: 1d8+4",
        "Javelin (30/120) — To Hit: d20+6 — Damage: 1d6+4"
      ],
      feats:[
        "Rage (2/long rest) — bonus action, 1 min: +2 dmg on STR attacks, adv on STR checks+saves, resist B/P/S",
        "Reckless Attack — first attack each turn: advantage; enemies have advantage to hit you until next turn",
        "Danger Sense — advantage on DEX saves vs effects you can see"
      ],
      spellSlots:null,
      magic:null,
      resources:[
        { key:"rage_1", name:"Rage (use #1)", rest:"long", effect:"Bonus action to enter Rage. (2/Long Rest)" },
        { key:"rage_2", name:"Rage (use #2)", rest:"long", effect:"Bonus action to enter Rage. (2/Long Rest)" },
      ]
    }
  ];

  // ===== UI WIRING =====
  const select = document.getElementById("pcSelect");
  const card = document.getElementById("card");
  const el = (id)=>document.getElementById(id);

  const hpCur = el("hpCur");
  const inv = el("inv");
  const notes = el("notes");
  const conds = el("conds");

  // Spell slots (embedded)
  const spellSlotsInline = el("spellSlotsInline");
  const spellHint = el("spellHint");
  const slotsL1 = el("slotsL1");
  const slotsL2 = el("slotsL2");
  const lineL1 = el("lineL1");
  const lineL2 = el("lineL2");

  const magicBox = el("magicBox");
  const cantripSection = el("cantripSection");
  const cantripHint = el("cantripHint");
  const cantripList = el("cantripList");

  const spellSection = el("spellSection");
  const spellPickHint = el("spellPickHint");
  const spellList = el("spellList");

  const tokenBox = el("tokenBox");
  const resourcesEl = el("resources");

  let currentPcId = null;

  function keyFor(pcId){ return `tracker::${pcId}`; }

  // ===== Resources "module" =====
  function createResourcesModule(container, onDirty){
    function render(pc, saved){
      container.innerHTML = "";
      const res = Array.isArray(pc.resources) ? pc.resources : [];
      if(res.length === 0){
        container.innerHTML = `<div class="muted">—</div>`;
        return;
      }

      res.forEach(r=>{
        const row = document.createElement("div");
        row.className = "checkrow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.dataset.resource = r.key;
        cb.checked = !!(saved?.resources?.[r.key]);
        cb.addEventListener("change", onDirty);

        const text = document.createElement("div");
        text.innerHTML = `<div class="title">${r.name} <span class="muted">(${r.rest} rest)</span></div>
                          <div class="desc">${r.effect}</div>`;

        const info = document.createElement("button");
        info.className = "infoBtn";
        info.type = "button";
        info.textContent = "?";
        info.addEventListener("click", ()=>{
          alert(`${r.name}\n\n${r.effect}\n\nResets on: ${r.rest} rest`);
        });

        row.appendChild(cb);
        row.appendChild(text);
        row.appendChild(info);
        container.appendChild(row);
      });
    }

    function getState(){
      const st = {};
      container.querySelectorAll("[data-resource]").forEach(cb=>{
        st[cb.dataset.resource] = !!cb.checked;
      });
      return st;
    }

    function resetByRest(pc, restType){
      container.querySelectorAll("[data-resource]").forEach(cb=>{
        const rKey = cb.dataset.resource;
        const res = (pc.resources||[]).find(r=>r.key===rKey);
        if(restType === "short"){
          if(res?.rest === "short") cb.checked = false;
        } else {
          cb.checked = false;
        }
      });
    }

    return { render, getState, resetByRest };
  }

  const ResourcesUI = createResourcesModule(resourcesEl, save);

  function populate(){
    select.innerHTML = "";
    PCS.forEach(pc=>{
      const o = document.createElement("option");
      o.value = pc.id;
      o.textContent = pc.name;
      select.appendChild(o);
    });

    const last = localStorage.getItem("party_tracker_last_pc");
    const firstId = PCS[0]?.id;
    select.value = PCS.some(p=>p.id===last) ? last : firstId;
    render(select.value);
  }

  function setList(listElId, items){
    const ul = el(listElId);
    ul.innerHTML = "";
    (items || []).forEach(t=>{
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
  }

  function renderSlots(container, levelKey, count){
    container.innerHTML = "";
    if(!count || count <= 0) return;

    for(let i=0;i<count;i++){
      const wrap = document.createElement("div");
      wrap.className = "slot";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.slot = `${levelKey}:${i}`;
      cb.addEventListener("change", save);
      wrap.appendChild(cb);
      container.appendChild(wrap);
    }
  }

  function syncSlotVisuals(){
    document.querySelectorAll(".slot").forEach(s=>{
      const cb = s.querySelector("input");
      s.classList.toggle("on", !!cb.checked);
    });
  }

  function updateHpPill(){
    const pc = PCS.find(p=>p.id===currentPcId);
    const maxHp = pc?.core?.maxHp ?? "—";
    const cur = hpCur.value || "—";
    el("hpPill").textContent = `HP: ${cur} / ${maxHp}`;
  }

  function getSavedState(){
    const raw = localStorage.getItem(keyFor(currentPcId));
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }

  function clampPicks(container, limit){
    if(limit <= 0) return;
    const checked = [...container.querySelectorAll("input[type=checkbox]")].filter(x=>x.checked);
    if(checked.length <= limit) return;
    checked.slice(limit).forEach(x=>x.checked = false);
  }

  function renderPickList(container, items, savedMap, limit, storageKey){
    container.innerHTML = "";
    (items || []).forEach(item=>{
      const row = document.createElement("div");
      row.className = "spellItem";

      const top = document.createElement("div");
      top.className = "spellTop";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.pick = item.name;
      cb.dataset.pickgroup = storageKey;
      cb.checked = !!savedMap?.[item.name];
      cb.addEventListener("change", ()=>{
        clampPicks(container, limit);
        save();
      });

      const body = document.createElement("div");
      body.style.flex = "1 1 auto";

      body.innerHTML = `
        <div class="spellName">${item.name}</div>
        ${item.meta ? `<div class="spellMeta">${item.meta}</div>` : ""}
        ${item.desc ? `<div class="spellDesc">${item.desc}</div>` : ""}
      `;

      top.appendChild(cb);
      top.appendChild(body);
      row.appendChild(top);
      container.appendChild(row);
    });
  }

  function renderMagic(pc, saved){
    const magic = pc.magic;
    if(!magic){
      magicBox.hidden = true;
      cantripSection.hidden = true;
      spellSection.hidden = true;
      cantripList.innerHTML = "";
      spellList.innerHTML = "";
      return;
    }

    magicBox.hidden = false;

    // Cantrips
    const ctPick = magic.cantripPick ?? 0;
    const ctItems = magic.cantrips ?? [];
    const ctSaved = saved?.cantrips || {};
    if(ctItems.length > 0 && ctPick > 0){
      cantripSection.hidden = false;
      cantripHint.textContent = `Cantrips — pick ${ctPick}`;
      renderPickList(cantripList, ctItems, ctSaved, ctPick, "cantrips");
    } else {
      cantripSection.hidden = true;
      cantripList.innerHTML = "";
    }

    // Spells
    const spPick = magic.spellPick ?? 0;
    const spItems = magic.spells ?? [];
    const spSaved = saved?.spells || {};
    if(spItems.length > 0 && spPick > 0){
      spellSection.hidden = false;
      spellPickHint.textContent = `Spells — pick ${spPick}`;
      renderPickList(spellList, spItems, spSaved, spPick, "spells");
    } else {
      spellSection.hidden = true;
      spellList.innerHTML = "";
    }
  }

  function load(){
    if(!currentPcId) return;

    const pc = PCS.find(p=>p.id===currentPcId);
    const st = getSavedState();

    if(!st){
      hpCur.value = pc?.core?.maxHp ?? "";
      inv.value = "";
      notes.value = "";
      conds.value = "";

      // clear slot checkboxes
      document.querySelectorAll(".slot input").forEach(cb=>cb.checked=false);

      syncSlotVisuals();
      updateHpPill();

      ResourcesUI.render(pc, null);
      renderMagic(pc, null);
      return;
    }

    hpCur.value = st.hpCur ?? (pc?.core?.maxHp ?? "");
    inv.value = st.inv ?? "";
    notes.value = st.notes ?? "";
    conds.value = st.conds ?? "";

    // slots
    const slotState = st.slots || {};
    document.querySelectorAll(".slot input").forEach(cb=>{
      cb.checked = !!slotState[cb.dataset.slot];
    });

    syncSlotVisuals();
    updateHpPill();

    ResourcesUI.render(pc, st);
    renderMagic(pc, st);
  }

  function save(){
    if(!currentPcId) return;

    const slotState = {};
    document.querySelectorAll(".slot input").forEach(cb=>{
      slotState[cb.dataset.slot] = !!cb.checked;
    });

    const st = {
      hpCur: hpCur.value,
      inv: inv.value,
      notes: notes.value,
      conds: conds.value,
      slots: slotState,
      resources: ResourcesUI.getState(),
      cantrips: {},
      spells: {}
    };

    // cantrip picks
    cantripList.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      st.cantrips[cb.dataset.pick] = !!cb.checked;
    });

    // spell picks
    spellList.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      st.spells[cb.dataset.pick] = !!cb.checked;
    });

    localStorage.setItem(keyFor(currentPcId), JSON.stringify(st));
    syncSlotVisuals();
    updateHpPill();
  }

  function renderToken(pc){
    tokenBox.innerHTML = "";
    if(pc.token){
      const img = document.createElement("img");
      img.src = pc.token;
      img.alt = pc.name + " token";
      tokenBox.appendChild(img);
    }else{
      tokenBox.innerHTML = "<span>—</span>";
    }
  }

  function render(id){
    const pc = PCS.find(p=>p.id===id);
    if(!pc) return;

    currentPcId = id;
    localStorage.setItem("party_tracker_last_pc", id);
    card.hidden = false;

    renderToken(pc);

    el("name").textContent = pc.name;
    el("sub").textContent = `${pc.race} • ${pc.cls}`;

    el("level").textContent = pc.level ?? "—";
    el("race").textContent  = pc.race ?? "—";
    el("cls").textContent   = pc.cls ?? "—";

    el("ac").textContent    = pc.core?.ac ?? "—";
    el("speed").textContent = pc.core?.speed ?? "—";
    el("init").textContent  = pc.core?.init ?? "—";
    el("prof").textContent  = pc.core?.prof ?? "—";
    el("maxhp").textContent = pc.core?.maxHp ?? "—";

    el("str").textContent = pc.abilities?.str ?? "—";
    el("dex").textContent = pc.abilities?.dex ?? "—";
    el("con").textContent = pc.abilities?.con ?? "—";
    el("int").textContent = pc.abilities?.int ?? "—";
    el("wis").textContent = pc.abilities?.wis ?? "—";
    el("cha").textContent = pc.abilities?.cha ?? "—";

    setList("skills", pc.skills);
    setList("saves", pc.saves);
    setList("attacks", pc.attacks);
    setList("feats", pc.feats);

    // spell slots (diamonds) now embedded
    if(pc.spellSlots){
      spellSlotsInline.hidden = false;
      const l1 = pc.spellSlots.l1 || 0;
      const l2 = pc.spellSlots.l2 || 0;

      spellHint.textContent = `Level 1: ${l1} slot(s)` + (l2 ? ` • Level 2: ${l2} slot(s)` : "");
      lineL1.hidden = (l1 <= 0);
      lineL2.hidden = (l2 <= 0);

      renderSlots(slotsL1, "L1", l1);
      renderSlots(slotsL2, "L2", l2);
    }else{
      spellSlotsInline.hidden = true;
      slotsL1.innerHTML = "";
      slotsL2.innerHTML = "";
    }

    load();
  }

  function doShortRest(){
    if(!currentPcId) return;
    const pc = PCS.find(p=>p.id===currentPcId);
    if(!pc) return;

    ResourcesUI.resetByRest(pc, "short");

    save();
    alert("Short Rest applied:\n- Short-rest resources reset.\n- Spell slots unchanged.");
  }

  function doLongRest(){
    if(!currentPcId) return;
    const pc = PCS.find(p=>p.id===currentPcId);
    if(!pc) return;

    ResourcesUI.resetByRest(pc, "long");

    // reset spell slots
    document.querySelectorAll(".slot input").forEach(cb=>cb.checked=false);

    const restore = confirm("Long Rest applied.\n\nRestore HP to max?");
    if(restore){
      hpCur.value = pc.core?.maxHp ?? hpCur.value;
    }

    save();
    alert("Long Rest applied:\n- Resources reset\n- Spell slots reset\n- HP " + (restore ? "restored to max" : "unchanged"));
  }

  // ===== events =====
  select.addEventListener("change", () => render(select.value));
  [hpCur, inv, notes, conds].forEach(x => x.addEventListener("input", save));

  document.getElementById("resetThis").addEventListener("click", ()=>{
    if(!currentPcId) return;
    if(confirm("Reset this PC on THIS device?")){
      localStorage.removeItem(keyFor(currentPcId));
      render(currentPcId);
    }
  });

  document.getElementById("shortRest").addEventListener("click", doShortRest);
  document.getElementById("longRest").addEventListener("click", doLongRest);

  populate();
</script>
</body>
</html>
